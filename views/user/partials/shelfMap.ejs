<div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
    <div class="bg-gray-100 px-4 py-3 border-b flex justify-between items-center">
        <h3 class="font-bold text-gray-700 flex items-center">
            <i class="fas fa-map-marked-alt text-blue-600 mr-2"></i> Denah Ruangan
        </h3>
    </div>

    <div class="p-6 overflow-auto max-h-[min(70vh,600px)] max-w-full min-w-0">
        <% 
            let shelfRaw = shelfLocation || '';
            // Simpan & cocokkan berdasarkan nama rak persis (toleran legacy "Rak X" vs "X")
            const normKey = (v) => String(v || '').replace(/['"]+/g, '').trim().replace(/\s/g,'').toUpperCase();
            const shelfKey = normKey(shelfRaw);
            const shelfKeyNoRak = normKey(String(shelfRaw || '').replace(/^Rak\s+/i, ''));
            // Check if we have dynamic layout JSON
            let hasDynamicLayout=false; let dRows=12;
            let dCols=16; let dItems=[]; if (layoutJson) { try { // Handle if layoutJson is string or object const
            lData=typeof layoutJson==='string' ? JSON.parse(layoutJson) : layoutJson; if (lData && lData.items) {
            hasDynamicLayout=true; dRows=lData.rows || 12; dCols=lData.cols || 16; dItems=lData.items || []; } }
            catch(e) { console.error("Error parsing layout JSON", e); } } %>

            <% if (hasDynamicLayout) { %>
                <!-- DYNAMIC GRID LAYOUT - scroll jika terlalu besar, denah di tengah -->
                <div class="relative w-full overflow-auto max-w-full min-w-0 flex justify-center items-center" style="max-height: min(65vh, 500px);">
                    <!-- Grid Container - proporsi mengikuti rowsÃ—cols dari layout -->
                    <div class="flex-shrink-0" style="
                    display: grid;
                    grid-template-columns: repeat(<%= dCols %>, minmax(0, 1fr));
                    grid-template-rows: repeat(<%= dRows %>, minmax(0, 1fr));
                    gap: clamp(2px, 0.6vw, 4px);
                    aspect-ratio: <%= dCols %> / <%= dRows %>;
                    width: 100%;
                    max-width: 100%;
                    background-color: #f9fafb;
                    padding: clamp(6px, 1.2vw, 10px);
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                ">
                        <!-- ITEMS OVERLAY (tanpa background kotak-kotak) -->
                        <% dItems.forEach(item=> {
                                            // Determine styling based on type
                                            let bgClass = 'bg-gray-300';
                                            let borderClass = 'border-gray-400';
                                            let textClass = 'text-gray-700';

                                            if (item.type === 'table') {
                                            bgClass = 'bg-red-400';
                                            borderClass = 'border-red-500';
                                            textClass = 'text-white';
                                            if (item.role === 'librarian' || (item.name && item.name.match(/pustakawan|admin/i))) { 
                                                bgClass = 'bg-teal-400'; 
                                                borderClass = 'border-teal-500'; 
                                            }
                                            if (item.role === 'guest' || (item.name && item.name.match(/tamu/i))) { 
                                                bgClass = 'bg-green-400';
                                                borderClass = 'border-green-500'; 
                                            }
                                            } else if (item.type === 'door') {
                                            bgClass = 'bg-orange-400';
                                            borderClass = 'border-orange-500';
                                            textClass = 'text-white';
                                            } else if (item.type === 'cabinet') {
                                            bgClass = 'bg-gray-400';
                                            borderClass = 'border-gray-500';
                                            textClass = 'text-white';
                                            } else if (item.type === 'rack') {
                                            // Highlight tepat 1 rak sesuai shelf_location (toleran legacy "Rak X")
                                            const nameKey = normKey(item.name);
                                            const nameKeyNoRak = normKey(String(item.name || '').replace(/^Rak\s+/i, ''));
                                            const isTarget = shelfKey && (
                                                nameKey === shelfKey ||
                                                (shelfKeyNoRak && nameKeyNoRak === shelfKeyNoRak)
                                            );

                                            if (isTarget) {
                                            bgClass = 'bg-blue-600 animate-pulse shadow-[0_0_15px_rgba(37,99,235,0.6)] z-20';
                                            borderClass = 'border-blue-800';
                                            textClass = 'text-white';
                                            }
                                            }
                                            %>
                                            <div style="
                            grid-column: <%= item.c1 %> / span <%= item.c2 - item.c1 + 1 %>;
                            grid-row: <%= item.r1 %> / span <%= item.r2 - item.r1 + 1 %>;
                            z-index: 10;
                        " class="relative flex items-center justify-center p-1 rounded-sm border shadow-sm transition-transform hover:scale-105 <%= bgClass %> <%= borderClass %>">
                                                <span
                                                    class="<%= textClass %> text-[9px] font-bold text-center leading-tight overflow-hidden break-words px-0.5">
                                                        <%= item.type === 'rack' ? (item.name || '') : '' %>
                                                </span>
                                            </div>
                                            <% }); %>
                    </div>
                </div>

                <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i>Geser denah jika ukuran melebihi tampilan.</p>

                <div class="mt-4 flex flex-wrap justify-center gap-4 text-xs font-medium text-gray-600">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-gray-300 border border-gray-400"></div>
                        <span>Rak Buku</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-teal-400 border border-gray-400"></div>
                        <span>Meja Petugas</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-red-400 border border-gray-400"></div>
                        <span>Meja Pengunjung</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-orange-400 border border-gray-400"></div>
                        <span>Pintu</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-green-400 border border-gray-400"></div>
                        <span>Meja Buku Tamu</span>
                    </div>
                    <% if (shelfKey) { %>
                        <div class="flex items-center gap-2 p-1 bg-blue-50 rounded border border-blue-200">
                            <div class="w-4 h-4 bg-blue-600 border border-blue-800 animate-pulse"></div>
                            <span class="text-blue-800 font-bold">Lokasi Buku (<%= shelfRaw %>)</span>
                        </div>
                        <% } %>
                </div>

                <% } else { %>
                    <div class="flex flex-col items-center justify-center min-h-[200px] text-gray-500 px-4 py-8 rounded-lg border border-gray-200 bg-gray-50">
                        <p class="text-sm font-medium mb-1">Denah tidak tersedia</p>
                        <p class="text-xs">Ruangan ini belum punya denah dari database.</p>
                        <% if (shelfKey) { %>
                            <div class="mt-4 flex items-center gap-2 p-2 bg-blue-50 rounded border border-blue-200">
                                <span class="text-blue-800 font-bold">Lokasi Buku: <%= shelfRaw %></span>
                            </div>
                        <% } %>
                    </div>
                <% } %>

    </div>
</div>