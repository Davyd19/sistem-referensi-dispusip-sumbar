<style>
.shelf-rack-cell-user .shelf-rack-label-user { display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 4; max-width: 100%; font-size: clamp(6px, 1.2vmin, 10px); line-height: 1.2; text-align: center; word-break: normal; overflow-wrap: break-word; white-space: normal; overflow: hidden; }
</style>
<div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
    <div class="bg-gray-100 px-4 py-3 border-b flex justify-between items-center">
        <h3 class="font-bold text-gray-700 flex items-center">
            <i class="fas fa-map-marked-alt text-blue-600 mr-2"></i> Denah Ruangan
        </h3>
    </div>

    <div class="p-6 overflow-hidden max-w-full min-w-0">
        <% 
            let shelfRaw = shelfLocation || '';
            // Simpan & cocokkan berdasarkan nama rak persis (toleran legacy "Rak X" vs "X")
            const normKey = (v) => String(v || '').replace(/['"]+/g, '').trim().replace(/\s/g,'').toUpperCase();
            const shelfKey = normKey(shelfRaw);
            const shelfKeyNoRak = normKey(String(shelfRaw || '').replace(/^Rak\s+/i, ''));
            // Check if we have dynamic layout JSON
            let hasDynamicLayout=false; let dRows=12;
            let dCols=16; let dItems=[]; if (layoutJson) { try { const
            lData=typeof layoutJson==='string' ? JSON.parse(layoutJson) : layoutJson; if (lData && lData.items) {
            hasDynamicLayout=true; dRows=lData.rows || 12; dCols=lData.cols || 16; dItems=lData.items || []; } }
            catch(e) { console.error("Error parsing layout JSON", e); } }
            const hasRack = dItems.some(it => it.type === 'rack');
            const hasTablePustakawan = dItems.some(it => it.type === 'table' && (it.role === 'librarian' || (it.name && /pustakawan|admin/i.test(it.name))));
            const hasTablePengunjung = dItems.some(it => it.type === 'table' && !(/pustakawan|admin/i.test(it.name || '')) && !(/tamu/i.test(it.name || '')));
            const hasTableTamu = dItems.some(it => it.type === 'table' && (it.role === 'guest' || (it.name && /tamu/i.test(it.name))));
            const hasDoor = dItems.some(it => it.type === 'door');
            %>

            <% if (hasDynamicLayout) { %>
                <!-- DYNAMIC GRID LAYOUT - menyesuaikan frame referensi 25Ã—40 -->
                <div id="shelf-map-frame-user" class="relative w-full min-h-[180px] overflow-hidden max-w-full min-w-0 flex justify-center items-center p-2" style="max-height: min(38vh, 280px);">
                    <div id="shelf-map-container-user" class="flex-shrink-0 bg-white border border-gray-300 rounded-lg overflow-hidden" data-cols="<%= dCols %>" data-rows="<%= dRows %>">
                        <div id="shelf-map-grid-user" class="shelf-map-grid-user grid gap-0.5 p-1 bg-gray-100 rounded-sm overflow-hidden" style="
                    grid-template-columns: repeat(<%= dCols %>, 1fr);
                    grid-template-rows: repeat(<%= dRows %>, 1fr);
                ">
                        <!-- ITEMS OVERLAY (tanpa background kotak-kotak) -->
                        <% dItems.forEach(item=> {
                                            // Determine styling based on type
                                            let bgClass = 'bg-gray-300';
                                            let borderClass = 'border-gray-400';
                                            let textClass = 'text-gray-700';

                                            if (item.type === 'table') {
                                            bgClass = 'bg-red-400';
                                            borderClass = 'border-red-500';
                                            textClass = 'text-white';
                                            if (item.role === 'librarian' || (item.name && item.name.match(/pustakawan|admin/i))) { 
                                                bgClass = 'bg-teal-400'; 
                                                borderClass = 'border-teal-500'; 
                                            }
                                            if (item.role === 'guest' || (item.name && item.name.match(/tamu/i))) { 
                                                bgClass = 'bg-green-400';
                                                borderClass = 'border-green-500'; 
                                            }
                                            } else if (item.type === 'door') {
                                            bgClass = 'bg-orange-400';
                                            borderClass = 'border-orange-500';
                                            textClass = 'text-white';
                                            } else if (item.type === 'cabinet') {
                                            bgClass = 'bg-gray-400';
                                            borderClass = 'border-gray-500';
                                            textClass = 'text-white';
                                            } else if (item.type === 'rack') {
                                            // Highlight tepat 1 rak sesuai shelf_location (toleran legacy "Rak X")
                                            const nameKey = normKey(item.name);
                                            const nameKeyNoRak = normKey(String(item.name || '').replace(/^Rak\s+/i, ''));
                                            const isTarget = shelfKey && (
                                                nameKey === shelfKey ||
                                                (shelfKeyNoRak && nameKeyNoRak === shelfKeyNoRak)
                                            );

                                            if (isTarget) {
                                            bgClass = 'bg-blue-600 animate-pulse shadow-[0_0_15px_rgba(37,99,235,0.6)] z-20';
                                            borderClass = 'border-blue-800';
                                            textClass = 'text-white';
                                            }
                                            }
                                            %>
                                            <div style="
                            grid-column: <%= item.c1 %> / span <%= item.c2 - item.c1 + 1 %>;
                            grid-row: <%= item.r1 %> / span <%= item.r2 - item.r1 + 1 %>;
                            z-index: 10;
                        " class="shelf-rack-cell-user relative flex items-center justify-center p-1 rounded-sm border shadow-sm transition-colors <%= bgClass %> <%= borderClass %>">
                                                <span class="shelf-rack-label-user <%= textClass %> font-bold px-0.5">
                                                        <%= item.type === 'rack' ? (item.name || '') : '' %>
                                                </span>
                                            </div>
                                            <% }); %>
                        </div>
                    </div>
                </div>

                <script>
                (function() {
                    const frame = document.getElementById('shelf-map-frame-user');
                    const container = document.getElementById('shelf-map-container-user');
                    const grid = document.getElementById('shelf-map-grid-user');
                    if (!frame || !container || !grid) return;
                    function fit() {
                        const cols = parseInt(container.getAttribute('data-cols') || 40, 10);
                        const rows = parseInt(container.getAttribute('data-rows') || 25, 10);
                        var pw = frame.clientWidth - 24, ph = frame.clientHeight - 24;
                        if (pw <= 0 || ph <= 0) {
                            pw = Math.max(400, (window.innerWidth || 800) - 100);
                            ph = Math.max(320, Math.min(500, (window.innerHeight || 600) * 0.5));
                        }
                        const gap = 2, pad = 8;
                        const availW = pw - (cols - 1) * gap - pad;
                        const availH = ph - (rows - 1) * gap - pad;
                        const size = Math.max(6, Math.min(Math.floor(availW / cols), Math.floor(availH / rows)));
                        const totalW = cols * size + (cols - 1) * gap + pad;
                        const totalH = rows * size + (rows - 1) * gap + pad;
                        grid.style.gridTemplateColumns = 'repeat(' + cols + ', ' + size + 'px)';
                        grid.style.gridTemplateRows = 'repeat(' + rows + ', ' + size + 'px)';
                        container.style.width = totalW + 'px';
                        container.style.height = totalH + 'px';
                    }
                    fit();
                    requestAnimationFrame(fit);
                    setTimeout(fit, 100);
                    var ro = new ResizeObserver(fit);
                    ro.observe(frame);
                })();
                </script>

                <div class="mt-4 flex flex-wrap justify-center gap-4 text-xs font-medium text-gray-600">
                    <% if (hasRack) { %><div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-gray-300 border border-gray-400"></div>
                        <span>Rak Buku</span>
                    </div><% } %>
                    <% if (hasTablePustakawan) { %><div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-teal-400 border border-gray-400"></div>
                        <span>Meja Petugas</span>
                    </div><% } %>
                    <% if (hasTablePengunjung) { %><div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-red-400 border border-gray-400"></div>
                        <span>Meja Pengunjung</span>
                    </div><% } %>
                    <% if (hasDoor) { %><div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-orange-400 border border-gray-400"></div>
                        <span>Pintu</span>
                    </div><% } %>
                    <% if (hasTableTamu) { %><div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-green-400 border border-gray-400"></div>
                        <span>Meja Buku Tamu</span>
                    </div><% } %>
                    <% if (shelfKey) { %>
                        <div class="flex items-center gap-2 p-1 bg-blue-50 rounded border border-blue-200">
                            <div class="w-4 h-4 bg-blue-600 border border-blue-800 animate-pulse"></div>
                            <span class="text-blue-800 font-bold">Lokasi Buku (<%= shelfRaw %>)</span>
                        </div>
                        <% } %>
                </div>

                <% } else { %>
                    <div class="flex flex-col items-center justify-center min-h-[200px] text-gray-500 px-4 py-8 rounded-lg border border-gray-200 bg-gray-50">
                        <p class="text-sm font-medium mb-1">Denah tidak tersedia</p>
                        <p class="text-xs">Ruangan ini belum punya denah dari database.</p>
                        <% if (shelfKey) { %>
                            <div class="mt-4 flex items-center gap-2 p-2 bg-blue-50 rounded border border-blue-200">
                                <span class="text-blue-800 font-bold">Lokasi Buku: <%= shelfRaw %></span>
                            </div>
                        <% } %>
                    </div>
                <% } %>

    </div>
</div>