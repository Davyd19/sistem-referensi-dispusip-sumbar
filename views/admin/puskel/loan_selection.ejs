<%- include('../partials/header') %>

<form action="/admin/puskel/loan" method="POST" class="flex flex-col gap-6 relative min-h-screen pb-20">
    <input type="hidden" name="institution_id" value="<%= institution.id %>">

    <div class="flex flex-col gap-4">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-book-medical text-blue-600"></i> Pilih Buku
                </h2>
                <p class="text-sm text-gray-500">Peminjam: <span class="font-bold text-blue-600"><%= institution.name %></span></p>
            </div>
            <a href="/admin/puskel/institution/<%= institution.id %>" class="text-gray-500 hover:text-gray-700 font-medium text-sm">
                Batal
            </a>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Filter Klasifikasi (DDC)</label>
                <select id="ddcFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">Semua Kategori</option>
                    <option value="0">000 - Karya Umum</option>
                    <option value="1">100 - Filsafat & Psikologi</option>
                    <option value="2">200 - Agama</option>
                    <option value="3">300 - Ilmu Sosial</option>
                    <option value="4">400 - Bahasa</option>
                    <option value="5">500 - Sains & Matematika</option>
                    <option value="6">600 - Teknologi</option>
                    <option value="7">700 - Kesenian & Rekreasi</option>
                    <option value="8">800 - Kesusastraan</option>
                    <option value="9">900 - Sejarah & Geografi</option>
                    <option value="other">Lainnya</option>
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cari Judul / Pengarang / No.Panggil</label>
                <input type="text" id="searchBox" placeholder="Ketik judul, pengarang, atau no induk..." class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div class="flex-none w-48">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tanggal Kembali</label>
                <input type="date" name="due_date" required 
                    min="<%= new Date().toISOString().split('T')[0] %>"
                    class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-blue-50 text-blue-700 font-semibold cursor-pointer focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="p-4 w-10">
                            <input id="checkbox-all" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                        </th>
                        <th scope="col" class="px-6 py-3">Judul Buku</th>
                        <th scope="col" class="px-6 py-3">Pengarang</th>
                        <th scope="col" class="px-6 py-3 text-center">No. Induk</th>
                        <th scope="col" class="px-6 py-3 text-center">No. Panggil</th>
                    </tr>
                </thead>
                <tbody id="booksTableBody">
                    <% availableBooks.forEach(copy => { 
                        // Siapkan data untuk filtering JS
                        const callNum = (copy.Book && copy.Book.call_number) ? copy.Book.call_number : '';
                        const firstChar = callNum.trim().charAt(0);
                        const category = isNaN(parseInt(firstChar)) ? 'other' : firstChar;
                        
                        const titleLower = copy.Book ? copy.Book.title.toLowerCase() : '';
                        const noIndukLower = copy.no_induk.toLowerCase();

                        // Ambil data pengarang & siapkan untuk search
                        let authors = '-';
                        if (copy.Book && copy.Book.Authors && copy.Book.Authors.length > 0) {
                            authors = copy.Book.Authors.map(a => a.name).join(', ');
                        }
                        const authorLower = authors.toLowerCase();
                    %>
                    <tr class="bg-white border-b hover:bg-gray-50 book-row cursor-pointer" 
                        data-category="<%= category %>" 
                        data-search="<%= titleLower %> <%= noIndukLower %> <%= authorLower %>"
                        onclick="toggleRow(this)">
                        
                        <td class="w-4 p-4">
                            <input type="checkbox" name="book_copy_ids" value="<%= copy.id %>" class="book-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 cursor-pointer" onclick="event.stopPropagation()">
                        </td>
                        <td class="px-6 py-4 font-medium text-gray-900">
                            <%= copy.Book ? copy.Book.title : 'Judul Error' %>
                        </td>
                        
                        <td class="px-6 py-4 text-gray-700">
                            <%= authors %>
                        </td>

                        <td class="px-6 py-4 text-center font-mono text-xs">
                            <%= copy.no_induk %>
                        </td>
                        <td class="px-6 py-4 text-center font-bold text-blue-600">
                            <%= callNum || '-' %>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
        
        <div id="noDataMessage" class="hidden p-8 text-center text-gray-500">
            Tidak ada buku yang sesuai filter.
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-lg flex justify-between items-center z-50 lg:ml-64">
        <div class="text-sm font-medium text-gray-600">
            Terpilih: <span id="selectedCount" class="font-bold text-blue-600 text-lg">0</span> Buku
        </div>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-bold shadow-md transition-transform active:scale-95 flex items-center gap-2">
            <i class="fas fa-save"></i> Proses Peminjaman
        </button>
    </div>
</form>

<script>
    const ddcFilter = document.getElementById('ddcFilter');
    const searchBox = document.getElementById('searchBox');
    const rows = document.querySelectorAll('.book-row');
    const noDataMessage = document.getElementById('noDataMessage');
    const checkboxes = document.querySelectorAll('.book-checkbox');
    const checkAll = document.getElementById('checkbox-all');
    const selectedCountSpan = document.getElementById('selectedCount');

    // Fungsi Filter
    function filterBooks() {
        const catValue = ddcFilter.value;
        const searchValue = searchBox.value.toLowerCase();
        let visibleCount = 0;

        rows.forEach(row => {
            const rowCat = row.getAttribute('data-category');
            const rowSearch = row.getAttribute('data-search');

            const matchCat = (catValue === 'all') || (rowCat === catValue);
            const matchSearch = rowSearch.includes(searchValue);

            if (matchCat && matchSearch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        noDataMessage.classList.toggle('hidden', visibleCount > 0);
    }

    // Fungsi Hitung Checkbox
    function updateCount() {
        const checked = document.querySelectorAll('.book-checkbox:checked').length;
        selectedCountSpan.textContent = checked;
    }

    // Fungsi Klik Baris untuk Centang
    function toggleRow(row) {
        const checkbox = row.querySelector('.book-checkbox');
        checkbox.checked = !checkbox.checked;
        updateCount();
    }

    // Event Listeners
    ddcFilter.addEventListener('change', filterBooks);
    searchBox.addEventListener('keyup', filterBooks);

    checkAll.addEventListener('change', function() {
        // Hanya centang yang sedang tampil (visible)
        rows.forEach(row => {
            if (row.style.display !== 'none') {
                const cb = row.querySelector('.book-checkbox');
                cb.checked = this.checked;
            }
        });
        updateCount();
    });

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateCount);
    });
</script>

<%- include('../partials/footer') %>