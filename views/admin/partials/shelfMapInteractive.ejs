<style>
.shelf-rack-cell .shelf-rack-label { display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 4; max-width: 100%; font-size: calc(var(--shelf-cell-px, 18) * 0.8px); line-height: 1.2; text-align: center; word-break: normal; overflow-wrap: break-word; white-space: normal; overflow: hidden; }
</style>
<% const useFillHeight = typeof fillHeight !== 'undefined' ? fillHeight : false; %>
<div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm <%= useFillHeight ? 'h-full min-h-0 flex flex-col' : '' %>">
    <% if (typeof showHeader !== 'undefined' && showHeader) { %>
    <div class="bg-gray-100 px-4 py-3 border-b flex justify-between items-center flex-shrink-0">
        <h3 class="font-bold text-gray-700 flex items-center">
            <i class="fas fa-map-marked-alt text-blue-600 mr-2"></i> Denah Ruangan
        </h3>
    </div>
    <% } %>
    <div class="<%= useFillHeight ? 'flex-1 min-h-0 flex flex-col p-6' : 'p-6' %>">
        <% 
            const isPopupParam = typeof isPopup !== 'undefined' ? isPopup : false;
            let shelfRaw = typeof shelfLocation !== 'undefined' ? shelfLocation : '';
            let shelf = shelfRaw.replace(/['"]+/g, '').trim();
            let hasDbLayout = false;
            let dRows = 12, dCols = 16, dItems = [];
            const layoutData = typeof layoutJson !== 'undefined' ? layoutJson : null;
            if (layoutData) {
                try {
                    const lData = typeof layoutData === 'string' ? JSON.parse(layoutData) : layoutData;
                    if (lData && Array.isArray(lData.items) && lData.items.length) {
                        hasDbLayout = true;
                        dRows = lData.rows || 12;
                        dCols = lData.cols || 16;
                        dItems = lData.items;
                    }
                } catch (e) { console.error('Error parsing layout JSON', e); }
            }
            function normalizeKey(v) {
                return String(v || '').replace(/['"]+/g, '').trim().replace(/\s/g, '').toUpperCase();
            }
            function isBookRack(name) {
                // Cocokkan 1 rak saja: exact match (case/space-insensitive).
                // Tetap toleran untuk legacy "Rak X" vs "X".
                const s1 = normalizeKey(shelf);
                if (!s1 || !name) return false;
                const n1 = normalizeKey(name);
                if (n1 === s1) return true;
                const s2 = normalizeKey(String(shelf).replace(/^Rak\s+/i, ''));
                const n2 = normalizeKey(String(name).replace(/^Rak\s+/i, ''));
                return !!s2 && !!n2 && n2 === s2;
            }
            const hasRack = dItems.some(it => it.type === 'rack');
            const hasTablePustakawan = dItems.some(it => it.type === 'table' && (it.role === 'librarian' || (it.name && /pustakawan|admin/i.test(it.name))));
            const hasTablePengunjung = dItems.some(it => it.type === 'table' && !(/pustakawan|admin/i.test(it.name || '')) && !(/tamu/i.test(it.name || '')));
            const hasTableTamu = dItems.some(it => it.type === 'table' && (it.role === 'guest' || (it.name && /tamu/i.test(it.name))));
            const hasDoor = dItems.some(it => it.type === 'door');
        %>
        <%
            const compactFrameParam = typeof compactFrame !== 'undefined' ? compactFrame : false;
            const mapSizeClass = hasDbLayout ? '' : (isPopupParam ? 'aspect-[2/1] max-h-[300px]' : 'aspect-[16/9] min-h-[120px]');
            const mapAspectStyle = hasDbLayout ? `aspect-ratio: ${dCols} / ${dRows};` : '';
            const frameClass = useFillHeight ? 'w-full flex-1 min-h-[200px] max-w-full overflow-hidden rounded-lg border border-gray-200 bg-gray-50 min-w-0 flex justify-center items-center p-2' : (compactFrameParam ? 'w-full h-[min(58vh,420px)] min-h-[280px] max-w-full overflow-hidden rounded-lg border border-gray-200 bg-gray-50 min-w-0 flex justify-center items-center p-2' : 'w-full h-[min(75vh,560px)] min-h-[320px] max-w-full overflow-hidden rounded-lg border border-gray-200 bg-gray-50 min-w-0 flex justify-center items-center p-2');
            const frameStyle = compactFrameParam ? '' : '-webkit-overflow-scrolling: touch; touch-action: pan-x pan-y;';
        %>
        <% if (hasDbLayout) { %><div id="shelf-map-frame" class="<%= frameClass %>" style="<%= frameStyle %>"><div id="shelf-map-scaled-wrap" class="flex-shrink-0 overflow-hidden"><% } %>
        <div 
            id="shelf-map-container" 
            class="relative bg-white border border-gray-300 shadow-sm rounded-lg overflow-hidden <%= hasDbLayout ? 'inline-block' : mapSizeClass ? 'w-full ' + mapSizeClass : 'w-full' %>"
            style="<%= mapAspectStyle %><%= hasDbLayout ? '' : '' %>"
            data-input-field-id="<%= typeof inputFieldId !== 'undefined' ? inputFieldId : 'shelf_location' %>"
            data-cols="<%= dCols %>"
            data-rows="<%= dRows %>"
            data-min-cell="<%= compactFrameParam ? '16' : '18' %>"
        >
            <% if (hasDbLayout) { %>
                <div class="shelf-map-grid w-full h-full grid gap-0.5 p-1 bg-gray-100 rounded-sm overflow-hidden min-h-0" style="
                    grid-template-columns: repeat(<%= dCols %>, 1fr);
                    grid-template-rows: repeat(<%= dRows %>, 1fr);
                ">
                    <% dItems.forEach(item => {
                        const spanR = (item.r2 || item.r1) - (item.r1 || 1) + 1;
                        const spanC = (item.c2 || item.c1) - (item.c1 || 1) + 1;
                        const r1 = item.r1 || 1, c1 = item.c1 || 1;
                        let bgClass = 'bg-gray-300', borderClass = 'border-gray-400', textClass = 'text-gray-700';
                        if (item.type === 'table') {
                            bgClass = 'bg-red-400'; borderClass = 'border-red-500'; textClass = 'text-white';
                            if (item.role === 'librarian' || (item.name && /pustakawan|admin/i.test(item.name))) { bgClass = 'bg-teal-400'; borderClass = 'border-teal-500'; }
                            else if (item.role === 'guest' || (item.name && /tamu/i.test(item.name))) { bgClass = 'bg-green-400'; borderClass = 'border-green-500'; }
                        } else if (item.type === 'door') { bgClass = 'bg-orange-400'; borderClass = 'border-orange-500'; textClass = 'text-white'; }
                        else if (item.type === 'cabinet') { bgClass = 'bg-gray-400'; borderClass = 'border-gray-500'; textClass = 'text-white'; }
                        else if (item.type === 'rack') {
                            if (isBookRack(item.name)) { bgClass = 'bg-blue-600 animate-pulse shadow-[0_0_15px_rgba(37,99,235,0.6)]'; borderClass = 'border-blue-800'; textClass = 'text-white'; }
                            else { bgClass = 'bg-gray-300'; borderClass = 'border-gray-500'; }
                        }
                        const isRack = item.type === 'rack' && (item.name != null && String(item.name).trim() !== '');
                        const rackName = isRack ? String(item.name).trim() : '';
                        const clickableClass = isRack ? 'cursor-pointer hover:brightness-105' : 'cursor-default';
                    %>
                        <div 
                            class="shelf-rack-cell flex items-center justify-center rounded-sm border-2 border-solid shadow-sm transition-colors duration-150 <%= bgClass %> <%= borderClass %> <%= textClass %> <%= clickableClass %> p-0.5 font-bold overflow-hidden select-none"
                            <% if (isRack) { %>data-rack-id="<%= rackName.replace(/"/g, '&quot;') %>"<% } %>
                            style="grid-column: <%= c1 %> / span <%= spanC %>; grid-row: <%= r1 %> / span <%= spanR %>; z-index: 10;"
                        ><span class="shelf-rack-label"><%= isRack ? rackName : '' %></span></div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="flex flex-col items-center justify-center h-full min-h-[120px] text-gray-500 px-4 py-6">
                    <p class="text-sm font-medium mb-1">Denah ruangan belum diatur</p>
                    <p class="text-xs">Atur denah di <strong>Kelola Ruangan</strong> (Super Admin) lalu pilih rak di sini.</p>
                </div>
            <% } %>
        </div>
        <% if (hasDbLayout) { %></div></div><% } %>
        
        <% if (hasDbLayout) { %><div class="mt-6 flex flex-wrap justify-center gap-4 text-xs font-medium text-gray-600 flex-shrink-0">
            <% if (hasRack) { %><div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-gray-300 border border-gray-400"></div> 
                <span>Rak Buku</span>
            </div><% } %>
            <% if (hasTablePustakawan) { %><div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-teal-400 border border-gray-400"></div> 
                <span>Meja Pustakawan</span>
            </div><% } %>
            <% if (hasTablePengunjung) { %><div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-red-400 border border-gray-400"></div> 
                <span>Meja Pengunjung</span>
            </div><% } %>
            <% if (hasTableTamu) { %><div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-green-400 border border-gray-400"></div> 
                <span>Meja Buku Tamu</span>
            </div><% } %>
            <% if (hasDoor) { %><div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-orange-400 border border-gray-400"></div> 
                <span>Pintu</span>
            </div><% } %>
            <div id="selected-rack-indicator" class="flex items-center gap-2 p-1 bg-blue-50 rounded border border-blue-200 min-w-[140px] <%= shelf ? '' : 'invisible' %>" aria-hidden="<%= shelf ? 'false' : 'true' %>">
                <div class="w-4 h-4 bg-blue-600 border border-blue-800 animate-pulse"></div> 
                <span class="text-blue-800 font-bold"><%= (typeof showHeader !== 'undefined' && showHeader) ? 'Lokasi Buku: ' : 'Rak Terpilih: ' %><span id="selected-rack-label"><%= shelf || '-' %></span></span>
            </div>
        </div><% } %>
        
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üó∫Ô∏è === SHELF MAP INTERACTIVE DIINISIALISASI ===');
    
    const mapContainer = document.getElementById('shelf-map-container');
    const shelfMapFrame = document.getElementById('shelf-map-frame');
    const shelfMapScaledWrap = document.getElementById('shelf-map-scaled-wrap');
    const shelfMapGrid = document.querySelector('.shelf-map-grid');
    
    if (!mapContainer) {
        console.error('‚ùå Map container TIDAK DITEMUKAN!');
        return;
    }
    
    // Ukuran grid: min 18px per cell (agar nama rak terbaca), scale transform jika map melebihi frame
    // Wrapper dengan ukuran scaled agar layout tidak overflow (denah tidak terpotong)
    // Font proporsional dengan cell (~62% dari cell) agar terbaca
    function fitGridToFrame() {
        if (!shelfMapFrame || !shelfMapGrid) return;
        const cols = parseInt(mapContainer.getAttribute('data-cols') || 40, 10);
        const rows = parseInt(mapContainer.getAttribute('data-rows') || 25, 10);
        var pw = shelfMapFrame.clientWidth - 24;
        var ph = shelfMapFrame.clientHeight - 24;
        if (pw <= 0 || ph <= 0) {
            var scrollContainer = document.getElementById('map-scroll-container');
            if (scrollContainer && scrollContainer.clientWidth > 0 && scrollContainer.clientHeight > 0) {
                pw = scrollContainer.clientWidth - 80;
                ph = scrollContainer.clientHeight - 80;
            }
            if (pw <= 0 || ph <= 0) {
                pw = Math.max(400, (window.innerWidth || 800) - 100);
                ph = Math.max(320, Math.min(600, (window.innerHeight || 800) * 0.6));
            }
        }
        const gap = 2, pad = 8;
        const availW = pw - (cols - 1) * gap - pad;
        const availH = ph - (rows - 1) * gap - pad;
        const minCell = parseInt(mapContainer.getAttribute('data-min-cell') || '18', 10);
        const fitSize = Math.min(Math.floor(availW / cols), Math.floor(availH / rows));
        const size = Math.max(minCell, Math.max(18, fitSize));
        const totalW = cols * size + (cols - 1) * gap + pad;
        const totalH = rows * size + (rows - 1) * gap + pad;
        let scale = 1;
        if (totalW > pw || totalH > ph) {
            scale = Math.min(pw / totalW, ph / totalH);
        }
        shelfMapGrid.style.gridTemplateColumns = 'repeat(' + cols + ', ' + size + 'px)';
        shelfMapGrid.style.gridTemplateRows = 'repeat(' + rows + ', ' + size + 'px)';
        mapContainer.style.width = totalW + 'px';
        mapContainer.style.height = totalH + 'px';
        mapContainer.style.maxWidth = 'none';
        mapContainer.style.maxHeight = 'none';
        mapContainer.style.transform = 'scale(' + scale + ')';
        mapContainer.style.transformOrigin = 'top left';
        shelfMapGrid.style.setProperty('--shelf-cell-px', String(size));
        if (shelfMapScaledWrap) {
            shelfMapScaledWrap.style.width = Math.round(totalW * scale) + 'px';
            shelfMapScaledWrap.style.height = Math.round(totalH * scale) + 'px';
        }
    }
    
    if (shelfMapFrame && shelfMapGrid) {
        fitGridToFrame();
        requestAnimationFrame(function() { fitGridToFrame(); });
        setTimeout(function() { fitGridToFrame(); }, 100);
        const ro = new ResizeObserver(function() { fitGridToFrame(); });
        ro.observe(shelfMapFrame);
    }
    
    console.log('‚úÖ Map container ditemukan');
    const inputFieldId = mapContainer.getAttribute('data-input-field-id') || 'shelf_location';
    console.log('üìç inputFieldId:', inputFieldId);
    
    const inputField = document.getElementById(inputFieldId);
    console.log('üìç inputField:', inputField);
    
    if (!inputField) {
        console.error('‚ùå Input field dengan ID "' + inputFieldId + '" tidak ditemukan');
        return;
    }
    
    console.log('‚úÖ Input field ditemukan');
    
    // Cek jumlah rak awal
    const racks = mapContainer.querySelectorAll('[data-rack-id]');
    console.log('üìä Jumlah rak awal:', racks.length);

    // State untuk rak yang dipilih
    let selectedRackId = null;
    
    // Fungsi untuk update highlight
    function updateHighlight(rackId) {
        console.log('üé® === updateHighlight DIPANGGIL ===');
        console.log('üì• Parameter rackId:', rackId);
        console.log('üì• rackId type:', typeof rackId);
        
        if (!mapContainer) {
            console.error('‚ùå mapContainer TIDAK ADA!');
            return;
        }
        
        // Hapus highlight dari semua rak (hanya dalam mapContainer)
        const allRacks = mapContainer.querySelectorAll('[data-rack-id]');
        console.log('üìä Total rak ditemukan:', allRacks.length);
        
        const rackIdClean = rackId != null ? String(rackId).replace(/^["']+|["']+$/g, '').trim() : '';
        const rackIdNorm = rackIdClean ? rackIdClean.replace(/\s/g, '').toUpperCase() : '';
        console.log('üîç Mencari rak dengan ID:', rackIdClean, 'norm:', rackIdNorm);
        
        let foundSelected = false;
        let processedCount = 0;
        
        allRacks.forEach((rack, index) => {
            let currentRackId = rack.getAttribute('data-rack-id');
            if (currentRackId != null) {
                currentRackId = String(currentRackId).replace(/^["']+|["']+$/g, '').trim();
            } else {
                currentRackId = '';
            }
            const currentNorm = currentRackId ? currentRackId.replace(/\s/g, '').toUpperCase() : '';
            const isSelected = rackIdNorm.length > 0 && currentNorm.length > 0 && currentNorm === rackIdNorm;
            
            if (isSelected) {
                foundSelected = true;
                console.log(`    üéØ RAK DIPILIH DITEMUKAN!`);
                console.log(`    üìç Element:`, rack);
                console.log(`    üìç TagName:`, rack.tagName);
                console.log(`    üìç Classes sebelum:`, rack.className);
                
                // Hapus semua class yang mungkin konflik
                rack.classList.remove('bg-gray-300', 'text-gray-700', 'border-gray-500', 
                                     'bg-blue-600', 'text-white', 'border-blue-800', 
                                     'z-10', 'bg-gray-200', 'bg-gray-400', 'animate-pulse');
                
                // Tambah class highlight dengan animate-pulse (berkedip seperti legenda)
                rack.classList.add('bg-blue-600', 'text-white', 'border-blue-800', 'z-10', 'animate-pulse');
                console.log(`    üìç Classes setelah:`, rack.className);
                
                // Set inline style dengan !important untuk memastikan warna ter-apply
                console.log(`    üé® Mengaplikasikan inline styles...`);
                rack.style.setProperty('background-color', '#2563eb', 'important'); // blue-600
                rack.style.setProperty('color', '#ffffff', 'important');
                rack.style.setProperty('border-color', '#1e3a8a', 'important'); // blue-800
                rack.style.setProperty('border-width', '2px', 'important');
                rack.style.setProperty('border-style', 'solid', 'important');
                rack.style.setProperty('z-index', '10', 'important');
                rack.style.setProperty('box-shadow', '0 0 15px rgba(37,99,235,0.6)', 'important');
                
                // Verifikasi style ter-apply
                const computedBg = window.getComputedStyle(rack).backgroundColor;
                const computedColor = window.getComputedStyle(rack).color;
                console.log(`    ‚úÖ Computed background-color:`, computedBg);
                console.log(`    ‚úÖ Computed color:`, computedColor);
                console.log(`    ‚úÖ Inline style background-color:`, rack.style.backgroundColor);
                console.log(`    ‚úÖ Inline style color:`, rack.style.color);
                
                // Force reflow untuk memastikan style ter-apply
                void rack.offsetHeight;
                console.log(`    ‚úÖ Reflow dipaksa`);
                
            } else {
                // Reset rak yang tidak dipilih (tetap border-2 agar ukuran konsisten)
                rack.classList.remove('bg-blue-600', 'text-white', 'border-blue-800', 'z-10', 'animate-pulse');
                rack.classList.add('bg-gray-300', 'text-gray-700', 'border-gray-500');
                
                // Reset inline style
                rack.style.removeProperty('background-color');
                rack.style.removeProperty('color');
                rack.style.removeProperty('border-color');
                rack.style.removeProperty('border-width');
                rack.style.removeProperty('border-style');
                rack.style.removeProperty('z-index');
                rack.style.removeProperty('box-shadow');
            }
            processedCount++;
        });
        
        console.log(`üìä Total rak diproses: ${processedCount}`);
        console.log(`üéØ Rak yang dipilih ditemukan: ${foundSelected ? '‚úÖ YA' : '‚ùå TIDAK'}`);
        
        // Update indicator
        const indicator = document.getElementById('selected-rack-indicator');
        const label = document.getElementById('selected-rack-label');
        if (indicator && label) {
            if (rackId) {
                label.textContent = rackIdClean;
                indicator.classList.remove('invisible');
                indicator.setAttribute('aria-hidden', 'false');
                console.log('‚úÖ Indicator di-update ke:', rackIdClean);
            } else {
                indicator.classList.add('invisible');
                indicator.setAttribute('aria-hidden', 'true');
                console.log('‚úÖ Indicator disembunyikan');
            }
        } else {
            console.warn('‚ö†Ô∏è Indicator atau label tidak ditemukan');
        }
        
        console.log('üé® === updateHighlight SELESAI ===');
    }
    
    // Event listener untuk klik rak
    if (mapContainer) {
        console.log('‚úÖ Event listener untuk klik rak dipasang pada mapContainer');
        mapContainer.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è ========================================');
            console.log('üñ±Ô∏è === CLICK EVENT DIPANGGIL ===');
            console.log('üñ±Ô∏è ========================================');
            console.log('üñ±Ô∏è Timestamp:', new Date().toISOString());
            console.log('üñ±Ô∏è selectedRackId SEBELUM click:', selectedRackId);
            console.log('üñ±Ô∏è inputField.value SEBELUM click:', inputField.value);
            console.log('üñ±Ô∏è Target element:', e.target);
            console.log('üñ±Ô∏è Target tagName:', e.target.tagName);
            console.log('üñ±Ô∏è Target classes:', e.target.className);
            
            // Cari elemen rak yang diklik (bisa rak itu sendiri atau child-nya)
            let rackElement = e.target.closest('[data-rack-id]');
            console.log('üñ±Ô∏è Rack element ditemukan:', rackElement);
            
            if (rackElement) {
                e.preventDefault();
                e.stopPropagation();
                const rackId = rackElement.getAttribute('data-rack-id');
                console.log('üñ±Ô∏è üì¶ Rack ID dari attribute:', rackId);
                console.log('üñ±Ô∏è üì¶ Rack ID type:', typeof rackId);
                console.log('üñ±Ô∏è üì¶ Rack ID length:', rackId ? rackId.length : 0);
                
                if (rackId != null && String(rackId).trim() !== '') {
                    const cleanRackId = String(rackId).replace(/^["']+|["']+$/g, '').trim();
                    console.log('üñ±Ô∏è üì¶ Clean Rack ID:', cleanRackId);
                    
                    const oldSelectedRackId = selectedRackId;
                    selectedRackId = cleanRackId;
                    console.log('üñ±Ô∏è ‚úÖ selectedRackId di-update dari:', oldSelectedRackId, 'ke:', selectedRackId);
                    
                    const oldInputValue = inputField.value;
                    const shelfValue = cleanRackId;
                    inputField.value = shelfValue;
                    console.log('üñ±Ô∏è ‚úÖ Input field di-update dari:', oldInputValue, 'ke:', shelfValue);
                    
                    // Update highlight
                    console.log('üñ±Ô∏è üé® Memanggil updateHighlight dengan:', cleanRackId);
                    updateHighlight(cleanRackId);
                    console.log('üñ±Ô∏è ‚úÖ updateHighlight SELESAI dipanggil');
                    
                    // Trigger custom event untuk memberitahu admin_edit_book.ejs bahwa user sudah klik rak baru
                    // Ini akan update tempShelfLocation di admin_edit_book.ejs
                    const userClickedEvent = new CustomEvent('userClickedRack', {
                        detail: { value: shelfValue, rackId: cleanRackId }
                    });
                    window.dispatchEvent(userClickedEvent);
                    console.log('üñ±Ô∏è üì¢ Event userClickedRack di-trigger dengan value:', shelfValue);
                    
                    // JANGAN trigger shelfLocationUpdated event karena ini akan memanggil initializeHighlight
                    // yang akan me-reset highlight ke nilai lama
                    // Hanya trigger change event biasa
                    console.log('üñ±Ô∏è üì¢ Triggering change event (TANPA shelfLocationUpdated)');
                    inputField.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('üñ±Ô∏è ‚úÖ Change event di-trigger');
                    console.log('üñ±Ô∏è selectedRackId SETELAH click:', selectedRackId);
                    console.log('üñ±Ô∏è inputField.value SETELAH click:', inputField.value);
                    console.log('üñ±Ô∏è ========================================');
                } else {
                    console.error('üñ±Ô∏è ‚ùå Rack ID TIDAK DITEMUKAN dari attribute!');
                }
            } else {
                console.warn('üñ±Ô∏è ‚ö†Ô∏è Rack element TIDAK DITEMUKAN (bukan klik pada rak)');
            }
        });
    } else {
        console.error('‚ùå mapContainer TIDAK DITEMUKAN, event listener tidak bisa dipasang!');
    }
    
    // Fungsi untuk inisialisasi highlight berdasarkan nilai input
    function initializeHighlight() {
        console.log('üîÑ ========================================');
        console.log('üîÑ === initializeHighlight DIPANGGIL ===');
        console.log('üîÑ ========================================');
        console.log('üîÑ Timestamp:', new Date().toISOString());
        console.log('üîÑ Stack trace:', new Error().stack);
        
        if (!inputField || !mapContainer) {
            console.log('üîÑ ‚ùå inputField atau mapContainer tidak ada, return');
            return;
        }
        
        console.log('üîÑ selectedRackId saat ini:', selectedRackId);
        console.log('üîÑ inputField.value saat ini:', inputField.value);
        
        // Pastikan map container sudah terlihat (popup sudah terbuka)
        const modal = document.getElementById('shelf-map-modal');
        if (modal && modal.classList.contains('hidden')) {
            console.log('üîÑ ‚è≠Ô∏è Popup masih hidden, return');
            return; // Skip jika popup masih hidden
        }
        
        // Cek apakah ada rak di map
        const allRacks = mapContainer.querySelectorAll('[data-rack-id]');
        if (allRacks.length === 0) {
            console.log('üîÑ ‚è≠Ô∏è Rak belum ter-render, return');
            return; // Skip jika rak belum ter-render
        }
        
        console.log('üîÑ Jumlah rak ditemukan:', allRacks.length);
        
        if (inputField.value) {
            const currentValue = inputField.value.trim();
            console.log('üîÑ currentValue dari input:', currentValue);
            const extractCandidates = (v) => {
                const raw = (v || '').replace(/['"]+/g, '').trim();
                if (!raw) return [];
                const noRak = raw.replace(/^Rak\s+/i, '').trim();
                return Array.from(new Set([raw, noRak].filter(Boolean)));
            };
            const candidates = extractCandidates(currentValue);
            const rackId = candidates[0] || '';
            if (rackId) {
                const rackIdNorm = rackId.replace(/\s/g, '').toUpperCase();
                console.log('üîÑ rackId yang diekstrak:', rackId, 'norm:', rackIdNorm);
                console.log('üîÑ selectedRackId:', selectedRackId);
                const selNorm = selectedRackId ? selectedRackId.replace(/\s/g, '').toUpperCase() : '';
                console.log('üîÑ Apakah selectedRackId === rackId?', selNorm && rackIdNorm && selNorm === rackIdNorm);
                if (selectedRackId && selNorm === rackIdNorm) {
                    console.log('üîÑ ‚ö†Ô∏è selectedRackId sudah sesuai dengan rackId, cek apakah sudah ter-highlight');
                    let alreadyHighlighted = false;
                    allRacks.forEach(rack => {
                        let cr = rack.getAttribute('data-rack-id');
                        const crNorm = cr ? cr.replace(/^["']+|["']+$/g, '').replace(/\s/g, '').trim().toUpperCase() : '';
                        if (crNorm === rackIdNorm) {
                            const computedBg = window.getComputedStyle(rack).backgroundColor;
                            if (computedBg.includes('rgb(37, 99, 235)') || computedBg.includes('rgb(37,99,235)')) alreadyHighlighted = true;
                        }
                    });
                    if (alreadyHighlighted) {
                        console.log('üîÑ ‚úÖ Rak sudah ter-highlight, SKIP');
                        console.log('üîÑ ========================================');
                        return;
                    }
                }
                let alreadyHighlighted2 = false;
                allRacks.forEach(rack => {
                    let cr = rack.getAttribute('data-rack-id');
                    const crNorm = cr ? cr.replace(/^["']+|["']+$/g, '').replace(/\s/g, '').trim().toUpperCase() : '';
                    const matchAny = candidates.some(c => c.replace(/\s/g, '').toUpperCase() === crNorm);
                    if (matchAny) {
                        const bg = window.getComputedStyle(rack).backgroundColor;
                        if (bg.includes('rgb(37, 99, 235)') || bg.includes('rgb(37,99,235)')) alreadyHighlighted2 = true;
                    }
                });
                if (alreadyHighlighted2 && selectedRackId && selNorm === rackIdNorm) {
                    console.log('üîÑ ‚úÖ Rak sudah ter-highlight dan selectedRackId sesuai, SKIP');
                    console.log('üîÑ ========================================');
                    return;
                }
                console.log('üîÑ üé® Memanggil updateHighlight dengan rackId:', rackId);
                const oldSelectedRackId = selectedRackId;
                selectedRackId = rackId;
                updateHighlight(rackId);
                console.log('üîÑ ‚úÖ updateHighlight SELESAI dipanggil');
            }
        } else {
            console.log('üîÑ ‚ö†Ô∏è inputField.value kosong, reset semua highlight');
            selectedRackId = null;
            updateHighlight(null);
        }
        console.log('üîÑ ========================================');
    }

    // Inisialisasi saat pertama kali load (skip jika map di dalam popup yang hidden)
    const modal = document.getElementById('shelf-map-modal');
    if (!modal || !modal.classList.contains('hidden')) {
        // Hanya inisialisasi jika popup tidak ada atau sudah terlihat
        initializeHighlight();
    }

    // Listen untuk event custom dari popup handler (untuk reset saat popup dibuka)
    if (mapContainer) {
        mapContainer.addEventListener('shelfLocationUpdated', function(e) {
            console.log('üì¢ ========================================');
            console.log('üì¢ === shelfLocationUpdated EVENT DITERIMA ===');
            console.log('üì¢ ========================================');
            console.log('üì¢ Timestamp:', new Date().toISOString());
            console.log('üì¢ Event detail:', e.detail);
            console.log('üì¢ selectedRackId saat ini:', selectedRackId);
            console.log('üì¢ inputField.value saat ini:', inputField.value);
            console.log('üì¢ Stack trace:', new Error().stack);
            
            if (e.detail && e.detail.value != null) {
                const oldValue = inputField.value;
                // Update nilai input field
                inputField.value = String(e.detail.value).replace(/['"]+/g, '').trim();
                console.log('üì¢ Input field di-update dari:', oldValue, 'ke:', e.detail.value);
                
                let valueToUse = inputField.value;
                const rackIdFromEvent = valueToUse;
                const rfNorm = rackIdFromEvent ? rackIdFromEvent.replace(/\s/g, '').toUpperCase() : '';
                const selNorm = selectedRackId ? selectedRackId.replace(/\s/g, '').toUpperCase() : '';
                if (valueToUse) inputField.value = valueToUse;
                if (rfNorm && selectedRackId && rfNorm === selNorm) {
                    console.log('üì¢ ‚ö†Ô∏è rackId dari event sama dengan selectedRackId, SKIP initializeHighlight untuk menghindari reset');
                    console.log('üì¢ ========================================');
                    return;
                }
                
                // Gunakan multiple delays untuk memastikan map sudah ter-render
                console.log('üì¢ üìÖ Memanggil initializeHighlight dengan delays: 50, 150, 300, 500ms');
                [50, 150, 300, 500].forEach(delay => {
                    setTimeout(function() {
                        console.log('üì¢ üìÖ initializeHighlight dipanggil dengan delay', delay, 'ms');
                        initializeHighlight();
                    }, delay);
                });
            } else {
                console.log('üì¢ ‚ö†Ô∏è Event detail tidak ada atau value kosong, reset highlight');
                // Jika tidak ada nilai, reset highlight
                const allRacks = mapContainer.querySelectorAll('[data-rack-id]');
                allRacks.forEach(rack => {
                    rack.classList.remove('bg-blue-600', 'text-white', 'border-blue-800', 'z-10', 'animate-pulse');
                    rack.classList.add('bg-gray-300', 'text-gray-700', 'border-gray-500');
                    rack.style.removeProperty('background-color');
                    rack.style.removeProperty('color');
                    rack.style.removeProperty('border-color');
                    rack.style.removeProperty('border-width');
                    rack.style.removeProperty('border-style');
                    rack.style.removeProperty('z-index');
                    rack.style.removeProperty('box-shadow');
                });
            }
            console.log('üì¢ ========================================');
        });
    }

    // Re-inisialisasi saat popup dibuka (observe modal visibility)
    if (modal) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const isVisible = !modal.classList.contains('hidden');
                    if (isVisible) {
                        // Popup baru dibuka, re-inisialisasi highlight dengan multiple delays
                        setTimeout(function() {
                            initializeHighlight();
                        }, 100);
                        setTimeout(function() {
                            initializeHighlight();
                        }, 300);
                        setTimeout(function() {
                            initializeHighlight();
                        }, 500);
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
    }

    // Juga listen untuk event custom 'popupOpened' dari parent dengan delay untuk padding responsif
    window.addEventListener('shelfMapPopupOpened', function() {
        [100, 200, 350, 500, 700, 1000, 1500].forEach(delay => {
            setTimeout(function() {
                if (typeof fitGridToFrame === 'function') fitGridToFrame();
                initializeHighlight();
            }, delay);
        });
    });

    // Listen untuk event force initialize
    window.addEventListener('forceInitializeHighlight', function(e) {
        if (e.detail && e.detail.value && inputField) {
            inputField.value = e.detail.value;
        }
        setTimeout(function() {
            initializeHighlight();
        }, 100);
        setTimeout(function() {
            initializeHighlight();
        }, 300);
    });

    // Expose fungsi untuk bisa dipanggil langsung dari luar
    if (mapContainer) {
        mapContainer.highlightFromValue = function(value) {
            // Pastikan input field tersedia
            const field = document.getElementById(inputFieldId);
            if (field && value) {
                field.value = value;
            }
            
            // Pastikan map container tersedia
            const container = document.getElementById('shelf-map-container');
            if (!container) return;
            
            const currentValue = field ? field.value.trim() : '';
            if (!currentValue) return;
            const raw = currentValue.replace(/['"]+/g, '').trim();
            if (!raw) return;
            const noRak = raw.replace(/^Rak\s+/i, '').trim();
            const candidates = Array.from(new Set([raw, noRak].filter(Boolean)));
            const rackId = candidates[0];
            const rackIdNorm = rackId.replace(/\s/g, '').toUpperCase();
            const allRacks = container.querySelectorAll('[data-rack-id]');
            allRacks.forEach(rack => {
                let cr = rack.getAttribute('data-rack-id');
                const crNorm = cr ? cr.replace(/^["']+|["']+$/g, '').replace(/\s/g, '').trim().toUpperCase() : '';
                const isSelected = candidates.some(c => c.replace(/\s/g, '').toUpperCase() === crNorm);
                
                if (isSelected) {
                    rack.classList.remove('bg-gray-300', 'text-gray-700', 'border-gray-500');
                    rack.classList.add('bg-blue-600', 'text-white', 'border-blue-800', 'z-10', 'animate-pulse');
                    
                    // Set inline style dengan !important untuk memastikan warna ter-apply
                    rack.style.setProperty('background-color', '#2563eb', 'important'); // blue-600
                    rack.style.setProperty('color', '#ffffff', 'important');
                    rack.style.setProperty('border-color', '#1e3a8a', 'important'); // blue-800
                    rack.style.setProperty('border-width', '2px', 'important');
                    rack.style.setProperty('border-style', 'solid', 'important');
                    rack.style.setProperty('z-index', '10', 'important');
                    rack.style.setProperty('box-shadow', '0 0 15px rgba(37,99,235,0.6)', 'important');
                } else {
                    rack.classList.remove('bg-blue-600', 'text-white', 'border-blue-800', 'z-10', 'animate-pulse');
                    rack.classList.add('bg-gray-300', 'text-gray-700', 'border-gray-500');
                    
                    // Reset inline style
                    rack.style.removeProperty('background-color');
                    rack.style.removeProperty('color');
                    rack.style.removeProperty('border-color');
                    rack.style.removeProperty('border-width');
                    rack.style.removeProperty('border-style');
                    rack.style.removeProperty('z-index');
                    rack.style.removeProperty('box-shadow');
                }
            });
            
            // Update indicator
            const indicator = document.getElementById('selected-rack-indicator');
            const label = document.getElementById('selected-rack-label');
            if (indicator && label) {
                label.textContent = rackId;
                indicator.classList.remove('invisible');
                indicator.setAttribute('aria-hidden', 'false');
            }
        };
    }
});
</script>
