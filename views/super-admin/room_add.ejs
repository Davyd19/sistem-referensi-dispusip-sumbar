<%- include('partials/header') %>

<div class="p-6 flex justify-center">
    <div class="w-full max-w-[1600px] bg-white rounded-xl shadow-lg border border-gray-100 overflow-visible">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">
                <i class="fas fa-building text-blue-600 mr-2"></i> Tambah Ruangan Baru
            </h2>
            <a href="/admin/rooms" class="text-sm text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i> Batal</a>
        </div>

        <form action="/admin/rooms/add" method="POST" class="p-6 space-y-6" id="formAddRoom">
            <% if (error) { %>
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
                    <p><%= error %></p>
                </div>
            <% } %>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Ruangan</label>
                <input type="text" name="nama_ruangan" id="inputNamaRuangan" placeholder="Contoh: Ruang Referensi, Ruang Anak"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                <p class="text-xs text-gray-500 mt-1">Nama ini akan muncul di halaman pemilihan OPAC.</p>
            </div>

            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 px-6 py-4">
                    <h3 class="text-lg font-bold text-white flex items-center">
                        <i class="fas fa-th-large mr-3 text-indigo-200"></i> Desain Tata Letak Ruangan
                    </h3>
                    <p class="text-indigo-100 text-sm mt-1">
                        Gambarkan denah ruangan dengan grid di bawah. Tambahkan minimal satu item (rak, meja, atau pintu) sebelum menyimpan.
                    </p>
                </div>

                <div class="p-6 space-y-6">
                    <!-- Langkah & Tombol -->
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="lg:w-1/2">
                            <h4 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-list-ol text-indigo-500 mr-2"></i> Langkah Menambah Item
                            </h4>
                            <ol class="space-y-2 text-sm text-gray-600">
                                <li class="flex gap-2"><span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">1</span> Klik salah satu tombol jenis item di samping (Rak, Meja, atau Pintu).</li>
                                <li class="flex gap-2"><span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">2</span> Di area grid, klik dan tarik untuk memblok area yang diinginkan.</li>
                                <li class="flex gap-2"><span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">3</span> Untuk <b>Rak</b>, isi nama saat diminta. Item lain diberi nama otomatis.</li>
                            </ol>
                        </div>
                        <div class="lg:w-1/2">
                            <h4 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-mouse-pointer text-indigo-500 mr-2"></i> Jenis Item & Alat
                            </h4>
                            <div class="flex flex-wrap gap-2" id="modeButtonsWrap">
                                <button type="button" id="btnAddRack" data-mode="add_rack"
                                    class="mode-btn bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold px-4 py-2.5 rounded-lg shadow transition flex items-center gap-2">
                                    <i class="fas fa-archive"></i> Rak
                                </button>
                                <button type="button" id="btnAddVisitorTable" data-mode="add_table_visitor"
                                    class="mode-btn bg-red-500 hover:bg-red-600 text-white text-sm font-bold px-4 py-2.5 rounded-lg shadow transition flex items-center gap-2">
                                    <i class="fas fa-users"></i> Meja Pengunjung
                                </button>
                                <button type="button" id="btnAddLibrarianTable" data-mode="add_table_librarian"
                                    class="mode-btn bg-teal-500 hover:bg-teal-600 text-white text-sm font-bold px-4 py-2.5 rounded-lg shadow transition flex items-center gap-2">
                                    <i class="fas fa-user-tie"></i> Meja Pustakawan
                                </button>
                                <button type="button" id="btnAddGuestTable" data-mode="add_table_guest"
                                    class="mode-btn bg-green-500 hover:bg-green-600 text-white text-sm font-bold px-4 py-2.5 rounded-lg shadow transition flex items-center gap-2">
                                    <i class="fas fa-book-open"></i> Meja Buku Tamu
                                </button>
                                <button type="button" id="btnAddDoor" data-mode="add_door"
                                    class="mode-btn bg-orange-500 hover:bg-orange-600 text-white text-sm font-bold px-4 py-2.5 rounded-lg shadow transition flex items-center gap-2">
                                    <i class="fas fa-door-open"></i> Pintu
                                </button>
                                <button type="button" id="btnClearLayout"
                                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-bold px-4 py-2.5 rounded-lg border border-gray-300 transition flex items-center gap-2">
                                    <i class="fas fa-eraser"></i> Reset Semua
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Ukuran Grid -->
                    <div class="flex flex-wrap items-end gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ukuran Grid Denah</label>
                            <div class="flex items-center gap-3">
                                <div>
                                    <span class="text-xs text-gray-500 block mb-1">Baris (maks. 60)</span>
                                    <input id="roomRows" type="number" min="4" max="60" value="25"
                                        class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                                        title="Maksimal 60 baris">
                                </div>
                                <span class="text-gray-400 font-bold">×</span>
                                <div>
                                    <span class="text-xs text-gray-500 block mb-1">Kolom (maks. 60)</span>
                                    <input id="roomCols" type="number" min="4" max="60" value="40"
                                        class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                                        title="Maksimal 60 kolom">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tips Interaksi -->
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <h4 class="text-sm font-bold text-amber-800 mb-2 flex items-center">
                            <i class="fas fa-hand-pointer text-amber-600 mr-2"></i> Cara Berinteraksi dengan Objek di Denah
                        </h4>
                        <div class="grid sm:grid-cols-3 gap-3 text-sm">
                            <div class="flex items-start gap-2">
                                <span class="flex-shrink-0 w-8 h-8 rounded-lg bg-white border border-amber-200 flex items-center justify-center text-amber-600"><i class="fas fa-mouse-pointer text-xs"></i></span>
                                <div>
                                    <b class="text-amber-900">Klik sekali</b>
                                    <p class="text-amber-800/90 text-xs">Menampilkan konfirmasi untuk menghapus objek dari denah.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="flex-shrink-0 w-8 h-8 rounded-lg bg-white border border-amber-200 flex items-center justify-center text-amber-600"><i class="fas fa-mouse text-xs"></i></span>
                                <div>
                                    <b class="text-amber-900">Klik 2× (double-click)</b>
                                    <p class="text-amber-800/90 text-xs">Membuka popup untuk mengubah nama objek.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="flex-shrink-0 w-8 h-8 rounded-lg bg-white border border-amber-200 flex items-center justify-center text-amber-600"><i class="fas fa-arrows-alt text-xs"></i></span>
                                <div>
                                    <b class="text-amber-900">Klik tahan & geser</b>
                                    <p class="text-amber-800/90 text-xs">Memindahkan objek ke posisi lain di denah.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ketentuan Ukuran -->
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                        <h4 class="text-sm font-bold text-slate-800 mb-2 flex items-center">
                            <i class="fas fa-ruler-combined text-slate-600 mr-2"></i> Ketentuan Ukuran Minimal
                        </h4>
                        <ul class="space-y-1.5 text-sm text-slate-700">
                            <li class="flex items-center gap-2"><i class="fas fa-check-circle text-emerald-500 text-xs"></i> <b>Rak & Meja</b>: Minimal 2×2 kotak (2 baris × 2 kolom).</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check-circle text-emerald-500 text-xs"></i> <b>Pintu</b>: Minimal 2 kotak berderet — horizontal (1×2) atau vertikal (2×1).</li>
                            <li class="flex items-center gap-2"><i class="fas fa-info-circle text-blue-500 text-xs"></i> Objek tidak boleh saling bertumpuk. Pilih area yang kosong.</li>
                        </ul>
                    </div>
                </div>

                <input type="hidden" name="layout_json" id="layoutJsonInput" value="">

                <div class="px-6 pb-6">
                    <div id="denahViewport" class="denah-viewport rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 p-4 max-w-full overflow-hidden min-h-[400px] flex justify-center items-center">
                        <div id="gridContainer" class="select-none inline-block origin-center"></div>
                    </div>
                    <p id="layoutStatus" class="text-xs text-gray-500 mt-2"></p>
                </div>
            </div>

            <hr class="border-gray-200">

            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 class="text-sm font-bold text-blue-800 mb-3 flex items-center">
                    <i class="fas fa-user-lock mr-2"></i> Buat Akun Admin Ruangan
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username Admin</label>
                        <input type="text" name="username" id="inputUsername" placeholder="admin_ref, admin_anak"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" name="password" id="inputPassword" placeholder="******"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <p class="text-xs text-blue-600 mt-2">
                    *Akun ini akan digunakan oleh petugas untuk login dan mengelola buku di ruangan tersebut.
                </p>
            </div>

            <div class="flex justify-end pt-4">
                <button type="submit" id="btnSubmitRoom" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-lg shadow transition transform active:scale-95">
                    <i class="fas fa-save mr-2"></i> Simpan Data
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal (reusable): input nama / konfirmasi reset -->
<div id="rdModalOverlay" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50 px-4">
    <div class="w-full max-w-md bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
        <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between gap-3">
            <h3 id="rdModalTitle" class="text-base font-extrabold text-gray-800">Modal</h3>
            <button type="button" id="rdModalClose" class="text-gray-400 hover:text-gray-700 transition" aria-label="Tutup">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="px-5 py-4">
            <p id="rdModalDesc" class="text-sm text-gray-600 mb-3 hidden"></p>
            <div id="rdModalInputWrap">
                <input id="rdModalInput" type="text"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                    placeholder="">
                <p id="rdModalHint" class="text-xs text-gray-500 mt-2 hidden"></p>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button type="button" id="rdModalCancel"
                    class="bg-white hover:bg-gray-100 text-gray-700 text-sm font-bold px-4 py-2 rounded-lg border border-gray-300 transition">
                    Batal
                </button>
                <button type="button" id="rdModalOk"
                    class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed text-white text-sm font-bold px-4 py-2 rounded-lg shadow transition">
                    Simpan
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.rd-grid { display: grid; gap: 6px; position: relative; }
.rd-cell { width: var(--rd-cell-size, 26px); height: var(--rd-cell-size, 26px); min-width: var(--rd-cell-size, 26px); min-height: var(--rd-cell-size, 26px); border-radius: 4px; border: 1px solid #e5e7eb; background: #f9fafb; box-sizing: border-box; }
.rd-cell:hover { outline: 2px solid rgba(99, 102, 241, 0.35); outline-offset: 0; }
.rd-item { display: flex; align-items: center; justify-content: center; border-radius: 6px; border: 2px solid; font-size: 10px; font-weight: 700; text-align: center; padding: 2px 4px; cursor: grab; overflow: hidden; transition: transform 0.15s, box-shadow 0.15s; }
.rd-item:hover { transform: scale(1.02); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
.rd-item:active { cursor: grabbing; }
.rd-item-label { overflow: hidden; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; line-height: 1.15; word-break: break-word; overflow-wrap: anywhere; font-size: calc(var(--rd-cell-size, 18px) * 0.8); text-align: center; }
.rd-item--rack { background: rgba(107, 114, 128, 0.35); border-color: #4b5563; color: #1f2937; }
.rd-item--table-visitor { background: rgba(248, 113, 113, 0.3); border-color: #dc2626; color: #7f1d1d; }
.rd-item--table-librarian { background: rgba(45, 212, 191, 0.3); border-color: #0d9488; color: #134e4a; }
.rd-item--table-guest { background: rgba(74, 222, 128, 0.3); border-color: #16a34a; color: #14532d; }
.rd-item--door { background: rgba(249, 115, 22, 0.3); border-color: #ea580c; color: #7c2d12; }
.rd-item--preview { opacity: 0.6; pointer-events: none; }
.rd-selection { display: flex; align-items: center; justify-content: center; border-radius: 6px; border: 2px dashed rgba(99, 102, 241, 0.8); background: rgba(99, 102, 241, 0.15); font-size: 10px; font-weight: 700; color: #3730a3; pointer-events: none; z-index: 5; }
</style>

<script>
(async () => {
  const gridEl = document.getElementById('gridContainer');
  const statusEl = document.getElementById('layoutStatus');
  const layoutInput = document.getElementById('layoutJsonInput');
  const rowsInput = document.getElementById('roomRows');
  const colsInput = document.getElementById('roomCols');
  const btnAddRack = document.getElementById('btnAddRack');
  const btnAddVisitorTable = document.getElementById('btnAddVisitorTable');
  const btnAddLibrarianTable = document.getElementById('btnAddLibrarianTable');
  const btnAddGuestTable = document.getElementById('btnAddGuestTable');
  const btnAddDoor = document.getElementById('btnAddDoor');
  const btnClear = document.getElementById('btnClearLayout');

  const state = { version: 1, rows: 25, cols: 40, items: [] };
  let mode = null;
  let isMouseDown = false;
  let dragStart = null, dragEnd = null;
  let movingItemId = null, moveStartCell = null, dropTarget = null;
  let hasMovedWhileDragging = false;
  let isModalOpen = false;
  let pendingDeleteTimeout = null;
  let pendingClickItemId = null;
  let pendingClickTime = 0;

  const modal = {
    overlay: document.getElementById('rdModalOverlay'),
    title: document.getElementById('rdModalTitle'),
    desc: document.getElementById('rdModalDesc'),
    inputWrap: document.getElementById('rdModalInputWrap'),
    input: document.getElementById('rdModalInput'),
    hint: document.getElementById('rdModalHint'),
    btnOk: document.getElementById('rdModalOk'),
    btnCancel: document.getElementById('rdModalCancel'),
    btnClose: document.getElementById('rdModalClose'),
  };

  const showModal = ({
    title,
    desc,
    hint,
    showInput = true,
    hideCancel = false,
    placeholder,
    defaultValue,
    okText = 'Simpan',
    okClass = 'bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300',
    validate,
  }) => {
    return new Promise((resolve) => {
      if (!modal.overlay) return resolve(null);

      isModalOpen = true;
      modal.title.textContent = title || 'Input';

      if (desc) { modal.desc.textContent = desc; modal.desc.classList.remove('hidden'); }
      else { modal.desc.textContent = ''; modal.desc.classList.add('hidden'); }

      if (hint) { modal.hint.textContent = hint; modal.hint.classList.remove('hidden'); }
      else { modal.hint.textContent = ''; modal.hint.classList.add('hidden'); }

      if (modal.inputWrap) {
        modal.inputWrap.classList.toggle('hidden', !showInput);
      }

      modal.input.placeholder = placeholder || '';
      modal.input.value = defaultValue != null ? String(defaultValue) : '';

      modal.btnOk.textContent = okText;
      modal.btnOk.className = `${okClass} disabled:cursor-not-allowed text-white text-sm font-bold px-4 py-2 rounded-lg shadow transition`;
      if (modal.btnCancel) modal.btnCancel.classList.toggle('hidden', !!hideCancel);

      const isValid = () => (showInput ? (validate ? !!validate(modal.input.value) : !!modal.input.value.trim()) : true);
      const update = () => { modal.btnOk.disabled = !isValid(); };

      const cleanup = () => {
        modal.input.removeEventListener('input', update);
        modal.input.removeEventListener('keydown', onKeydown);
        modal.btnOk.removeEventListener('click', onOk);
        modal.btnCancel.removeEventListener('click', onCancel);
        modal.btnClose.removeEventListener('click', onCancel);
        modal.overlay.removeEventListener('click', onOverlay);
      };

      const hide = () => {
        modal.overlay.classList.add('hidden');
        modal.overlay.classList.remove('flex');
        isModalOpen = false;
      };

      const finish = (val) => {
        cleanup();
        hide();
        resolve(val);
      };

      const onOk = () => finish(showInput ? String(modal.input.value || '').trim() : '__ok__');
      const onCancel = () => finish(null);
      const onOverlay = (e) => { if (e.target === modal.overlay) onCancel(); };
      const onKeydown = (e) => {
        if (e.key === 'Escape') { e.preventDefault(); onCancel(); }
        if (e.key === 'Enter') { e.preventDefault(); if (!modal.btnOk.disabled) onOk(); }
      };

      modal.input.addEventListener('input', update);
      modal.input.addEventListener('keydown', onKeydown);
      modal.btnOk.addEventListener('click', onOk);
      modal.btnCancel.addEventListener('click', onCancel);
      modal.btnClose.addEventListener('click', onCancel);
      modal.overlay.addEventListener('click', onOverlay);

      update();
      modal.overlay.classList.remove('hidden');
      modal.overlay.classList.add('flex');
      setTimeout(() => {
        if (showInput) {
          modal.input.focus();
          modal.input.select();
        } else {
          modal.btnOk.focus();
        }
      }, 0);
    });
  };

  const showAlert = (title, desc) => showModal({
    title: title || 'Perhatian',
    desc: desc || '',
    showInput: false,
    hideCancel: true,
    okText: 'Mengerti',
    okClass: 'bg-amber-600 hover:bg-amber-700 disabled:bg-amber-300',
  });

  const rectNormalize = (a, b) => ({ r1: Math.min(a.r, b.r), c1: Math.min(a.c, b.c), r2: Math.max(a.r, b.r), c2: Math.max(a.c, b.c) });
  const rectContains = (rect, r, c) => r >= rect.r1 && r <= rect.r2 && c >= rect.c1 && c <= rect.c2;
  const rectOverlap = (a, b) => !(a.r2 < b.r1 || a.r1 > b.r2 || a.c2 < b.c1 || a.c1 > b.c2);
  const getOccupiedRects = () => state.items.map(it => ({ ...it }));

  const serialize = () => {
    layoutInput.value = JSON.stringify({ version: state.version, rows: state.rows, cols: state.cols, items: state.items });
  };

  const tableStyleFromName = (name) => {
    const n = String(name || '').toLowerCase();
    if (n.includes('pustakawan')) return 'librarian';
    if (n.includes('buku tamu') || n.includes('tamu')) return 'guest';
    return 'visitor';
  };

  const setStatus = () => {
    const rackCount = state.items.filter(i => i.type === 'rack').length;
    const tables = state.items.filter(i => i.type === 'table');
    const tableVisitorCount = tables.filter(t => tableStyleFromName(t.name) === 'visitor').length;
    const tableLibrarianCount = tables.filter(t => tableStyleFromName(t.name) === 'librarian').length;
    const tableGuestCount = tables.filter(t => tableStyleFromName(t.name) === 'guest').length;
    const doorCount = state.items.filter(i => i.type === 'door').length;
    let modeText = '';
    if (mode === 'add_rack') modeText = ' • Mode: tambah Rak';
    if (mode === 'add_table_visitor') modeText = ' • Mode: tambah Meja Pengunjung';
    if (mode === 'add_table_librarian') modeText = ' • Mode: tambah Meja Pustakawan';
    if (mode === 'add_table_guest') modeText = ' • Mode: tambah Meja Buku Tamu';
    if (mode === 'add_door') modeText = ' • Mode: tambah Pintu';
    statusEl.textContent = `Rak: ${rackCount}, Meja Pengunjung: ${tableVisitorCount}, Meja Pustakawan: ${tableLibrarianCount}, Meja Buku Tamu: ${tableGuestCount}, Pintu: ${doorCount} • Grid: ${state.rows}×${state.cols}` + modeText;
  };

  const itemTypeClass = (it) => {
    if (it.type === 'rack') return 'rd-item--rack';
    if (it.type === 'door') return 'rd-item--door';
    if (it.type === 'table') {
      const style = tableStyleFromName(it.name);
      if (style === 'librarian') return 'rd-item--table-librarian';
      if (style === 'guest') return 'rd-item--table-guest';
      return 'rd-item--table-visitor';
    }
    return 'rd-item--rack';
  };

  const ensureGridSize = async () => {
    const nr = Math.max(4, Math.min(60, Number(rowsInput.value) || 25));
    const nc = Math.max(4, Math.min(60, Number(colsInput.value) || 40));
    rowsInput.value = String(nr);
    colsInput.value = String(nc);
    if (nr < state.rows || nc < state.cols) {
      const wouldCut = state.items.some(it => it.r2 > nr || it.c2 > nc);
      if (wouldCut) {
        rowsInput.value = String(state.rows);
        colsInput.value = String(state.cols);
        await showAlert('Perhatian', 'Rows/Cols tidak boleh dikecilkan karena ada objek di area tersebut. Hapus atau pindahkan objek terlebih dahulu.');
        return;
      }
    }
    state.rows = nr;
    state.cols = nc;
    state.items = state.items.filter(it => it.r2 <= nr && it.c2 <= nc);
  };

  const promptText = async (label, placeholder = '') => {
    return await showModal({
      title: label || 'Nama',
      desc: null,
      hint: 'Wajib diisi.',
      placeholder: placeholder || '',
      defaultValue: placeholder || '',
      okText: 'Simpan',
      okClass: 'bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300',
      validate: (v) => String(v || '').trim().length > 0,
    });
  };

  const addItem = async (rect, subType) => {
    const occupied = getOccupiedRects();
    if (occupied.some(it => rectOverlap(it, rect))) {
      await showAlert('Perhatian', 'Area yang dipilih sudah terpakai. Pilih area lain.');
      return false;
    }
    const baseType = subType === 'rack' ? 'rack' : subType === 'door' ? 'door' : 'table';
    const h = rect.r2 - rect.r1 + 1, w = rect.c2 - rect.c1 + 1;
    if ((baseType === 'rack' || baseType === 'table') && (h < 2 || w < 2)) {
      await showAlert('Perhatian', 'Rak dan meja minimal 2×2 kotak. Pilih area yang lebih besar.');
      return false;
    }
    if (baseType === 'door' && !((h >= 2 && w >= 1) || (h >= 1 && w >= 2))) {
      await showAlert('Perhatian', 'Pintu minimal 1×2 atau 2×1 kotak (horizontal atau vertikal). Pilih area 2 kotak berderet.');
      return false;
    }
    let defaultName = 'Rak ' + (state.items.filter(x => x.type === 'rack').length + 1);
    let promptMsg = 'Nama Rak:';
    if (subType === 'table_visitor') { defaultName = 'Meja Pengunjung ' + (state.items.filter(x => x.type === 'table' && /meja pengunjung/i.test(x.name || '')).length + 1); promptMsg = 'Nama Meja Pengunjung:'; }
    else if (subType === 'table_librarian') { defaultName = 'Meja Pustakawan ' + (state.items.filter(x => x.type === 'table' && /meja pustakawan|pustakawan/i.test(x.name || '')).length + 1); promptMsg = 'Nama Meja Pustakawan:'; }
    else if (subType === 'table_guest') { defaultName = 'Meja Buku Tamu ' + (state.items.filter(x => x.type === 'table' && /meja buku tamu|buku tamu/i.test(x.name || '')).length + 1); promptMsg = 'Nama Meja Buku Tamu:'; }
    else if (subType === 'door') { defaultName = 'Pintu ' + (state.items.filter(x => x.type === 'door').length + 1); promptMsg = 'Nama Pintu:'; }
    let name = null;
    if (baseType === 'rack') {
      name = await promptText(promptMsg, defaultName);
      if (!name) return false;
    } else {
      // selain rak, tidak perlu input nama (otomatis)
      name = defaultName;
    }
    state.items.push({ id: `${baseType}_${Date.now()}_${Math.random().toString(16).slice(2)}`, type: baseType, name, ...rect });
    return true;
  };

  const resetTempSelection = () => { dragStart = null; dragEnd = null; isMouseDown = false; };

  const getCellFromMouse = (clientX, clientY) => {
    const wrapper = document.getElementById('denahViewport');
    if (!wrapper || !gridEl) return null;
    const br = gridEl.getBoundingClientRect();
    const step = (lastCellSize + GAP) * lastScale;
    const c = Math.floor((clientX - br.left + 3) / step) + 1;
    const r = Math.floor((clientY - br.top + 3) / step) + 1;
    if (r < 1 || r > state.rows || c < 1 || c > state.cols) return null;
    return { r, c };
  };

  const tryMoveItem = (it, r1, c1) => {
    const h = it.r2 - it.r1 + 1, w = it.c2 - it.c1 + 1;
    r1 = Math.max(1, Math.min(state.rows - h + 1, r1));
    c1 = Math.max(1, Math.min(state.cols - w + 1, c1));
    const r2 = r1 + h - 1, c2 = c1 + w - 1;
    const others = state.items.filter(x => x.id !== it.id);
    const newRect = { r1, c1, r2, c2 };
    if (others.some(o => rectOverlap(o, newRect))) return false;
    it.r1 = r1; it.c1 = c1; it.r2 = r2; it.c2 = c2;
    return true;
  };

  const setMode = (newMode) => {
    if (mode === newMode) mode = null;
    else mode = newMode;
    resetTempSelection();
    movingItemId = null;
    render();
    updateModeButtons();
  };

  function updateModeButtons() {
    const wrap = document.getElementById('modeButtonsWrap');
    if (!wrap) return;
    wrap.querySelectorAll('[data-mode]').forEach(btn => {
      const active = mode && btn.getAttribute('data-mode') === mode;
      btn.classList.toggle('ring-4', active);
      btn.classList.toggle('ring-gray-900', active);
      btn.classList.toggle('ring-offset-2', active);
      btn.classList.toggle('shadow-inner', active);
      btn.classList.toggle('scale-95', active);
      btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      btn.title = active ? 'Mode aktif — klik lagi untuk batal' : 'Klik untuk mode tambah';
    });
  }

  const denahViewport = document.getElementById('denahViewport');
  const GAP = 6;
  const PAD = 16;
  let lastCellSize = 26;
  let lastScale = 1;

  function fitGridToViewport() {
    if (!denahViewport) return 26;
    const cols = state.cols;
    const rows = state.rows;
    let pw = denahViewport.clientWidth - PAD * 2;
    let ph = denahViewport.clientHeight - PAD * 2;
    if (pw <= 0 || ph <= 0 || pw < 400) {
      pw = Math.max(800, (window.innerWidth || 1200) - 120);
      ph = Math.max(450, (window.innerHeight || 800) * 0.55);
    }
    const availW = pw - (cols - 1) * GAP;
    const availH = ph - (rows - 1) * GAP;
    const minCell = 18;
    const fitSize = Math.min(Math.floor(availW / cols), Math.floor(availH / rows));
    const size = Math.max(minCell, Math.min(32, fitSize));
    const totalW = cols * size + (cols - 1) * GAP;
    const totalH = rows * size + (rows - 1) * GAP;
    let scale = 1;
    if (totalW > pw || totalH > ph) {
      scale = Math.min(pw / totalW, ph / totalH);
    }
    gridEl.style.transform = 'scale(' + scale + ')';
    gridEl.style.transformOrigin = 'center center';
    lastCellSize = size;
    lastScale = scale;
    return size;
  }

  const render = () => {
    const cellSize = fitGridToViewport();
    gridEl.className = 'rd-grid';
    gridEl.style.setProperty('--rd-cell-size', cellSize + 'px');
    gridEl.style.gridTemplateColumns = `repeat(${state.cols}, ${cellSize}px)`;
    gridEl.style.gridTemplateRows = `repeat(${state.rows}, ${cellSize}px)`;
    if (denahViewport) {
      denahViewport.style.overflowX = 'hidden';
      denahViewport.style.overflowY = 'hidden';
    }

    const occupied = getOccupiedRects().filter(it => it.id !== movingItemId);
    const selection = (dragStart && dragEnd) ? rectNormalize(dragStart, dragEnd) : null;

    const emptySet = new Set();
    for (let r = 1; r <= state.rows; r++)
      for (let c = 1; c <= state.cols; c++)
        if (!occupied.some(it => rectContains(it, r, c))) emptySet.add(`${r}:${c}`);

    gridEl.innerHTML = '';

    emptySet.forEach(key => {
      const [r, c] = key.split(':').map(Number);
      const div = document.createElement('div');
      div.className = 'rd-cell';
      div.dataset.r = String(r);
      div.dataset.c = String(c);
      div.title = `(${r},${c})`;
      div.style.gridRow = String(r);
      div.style.gridColumn = String(c);
      gridEl.appendChild(div);
    });

    state.items.forEach(it => {
      if (it.id === movingItemId) return;
      const div = document.createElement('div');
      div.className = `rd-item ${itemTypeClass(it)}`;
      div.dataset.itemId = it.id;
      div.title = (it.name || '').trim() + ' — klik-tahan & geser untuk pindah, lepas tanpa geser untuk hapus';
      const spanR = it.r2 - it.r1 + 1, spanC = it.c2 - it.c1 + 1;
      div.style.gridRow = `${it.r1} / span ${spanR}`;
      div.style.gridColumn = `${it.c1} / span ${spanC}`;
      const label = document.createElement('span');
      label.className = 'rd-item-label';
      label.textContent = it.name || '';
      div.appendChild(label);
      gridEl.appendChild(div);
    });

    if (movingItemId && dropTarget) {
      const it = state.items.find(x => x.id === movingItemId);
      if (it) {
        const h = it.r2 - it.r1 + 1, w = it.c2 - it.c1 + 1;
        let r1 = Math.max(1, Math.min(state.rows - h + 1, dropTarget.r));
        let c1 = Math.max(1, Math.min(state.cols - w + 1, dropTarget.c));
        const div = document.createElement('div');
        div.className = `rd-item rd-item--preview ${itemTypeClass(it)}`;
        div.style.gridRow = `${r1} / span ${h}`;
        div.style.gridColumn = `${c1} / span ${w}`;
        const label = document.createElement('span');
        label.className = 'rd-item-label';
        label.textContent = it.name || '';
        div.appendChild(label);
        gridEl.appendChild(div);
      }
    }

    if (selection && mode) {
      const sel = document.createElement('div');
      sel.className = 'rd-selection';
      const spanR = selection.r2 - selection.r1 + 1, spanC = selection.c2 - selection.c1 + 1;
      sel.style.gridRow = `${selection.r1} / span ${spanR}`;
      sel.style.gridColumn = `${selection.c1} / span ${spanC}`;
      sel.textContent = 'Lepas untuk tambah';
      gridEl.appendChild(sel);
    }

    serialize();
    setStatus();
  };

  btnAddRack.addEventListener('click', () => setMode('add_rack'));
  btnAddVisitorTable.addEventListener('click', () => setMode('add_table_visitor'));
  btnAddLibrarianTable.addEventListener('click', () => setMode('add_table_librarian'));
  btnAddGuestTable.addEventListener('click', () => setMode('add_table_guest'));
  btnAddDoor.addEventListener('click', () => setMode('add_door'));

  btnClear.addEventListener('click', async () => {
    const ok = await showModal({
      title: 'Konfirmasi Reset Denah Ruangan',
      desc: 'Reset akan menghapus semua item (rak, meja, pintu) pada denah ini. Lanjutkan?',
      hint: null,
      showInput: false,
      okText: 'Reset',
      okClass: 'bg-red-600 hover:bg-red-700 disabled:bg-red-300',
      validate: null,
    });
    if (!ok) return;
    state.items = [];
    mode = null;
    resetTempSelection();
    render();
    updateModeButtons();
  });

  rowsInput.addEventListener('change', async () => { await ensureGridSize(); render(); });
  colsInput.addEventListener('change', async () => { await ensureGridSize(); render(); });

  if (denahViewport) {
    const ro = new ResizeObserver(() => render());
    ro.observe(denahViewport);
  }

  gridEl.addEventListener('mousedown', (e) => {
    if (isModalOpen) return;
    const item = e.target.closest('.rd-item');
    if (item && !item.classList.contains('rd-item--preview')) {
      const itemId = item.dataset.itemId;
      const it = state.items.find(x => x.id === itemId);
      if (!it) return;
      e.preventDefault();
      movingItemId = itemId;
      moveStartCell = { r: it.r1, c: it.c1 };
      dropTarget = { r: it.r1, c: it.c1 };
      hasMovedWhileDragging = false;
      resetTempSelection();
      render();
      return;
    }
    const cell = e.target.closest('.rd-cell');
    if (!cell) return;
    if (!mode) return;
    isMouseDown = true;
    dragStart = { r: Number(cell.dataset.r), c: Number(cell.dataset.c) };
    dragEnd = { ...dragStart };
    render();
  });

  gridEl.addEventListener('dblclick', async (e) => {
    if (isModalOpen) return;
    const item = e.target.closest('.rd-item');
    if (!item || item.classList.contains('rd-item--preview')) return;
    const itemId = item.dataset.itemId;
    const it = state.items.find(x => x.id === itemId);
    if (!it) return;
    e.preventDefault();
    e.stopPropagation();
    if (pendingDeleteTimeout) {
      clearTimeout(pendingDeleteTimeout);
      pendingDeleteTimeout = null;
    }
    movingItemId = null;
    moveStartCell = null;
    dropTarget = null;
    const newName = await showModal({
      title: 'Ubah Nama Objek',
      desc: `Objek saat ini: \"${it.name}\"`,
      hint: 'Masukkan nama baru.',
      showInput: true,
      placeholder: it.name || '',
      defaultValue: it.name || '',
      okText: 'Simpan',
      okClass: 'bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300',
      validate: (v) => String(v || '').trim().length > 0,
    });
    if (newName) {
      it.name = newName.trim();
      render();
    }
  });

  gridEl.addEventListener('mouseover', (e) => {
    if (isModalOpen) return;
    if (!isMouseDown || !mode) return;
    const cell = e.target.closest('.rd-cell');
    if (!cell) return;
    dragEnd = { r: Number(cell.dataset.r), c: Number(cell.dataset.c) };
    render();
  });

  window.addEventListener('mousemove', (e) => {
    if (isModalOpen) return;
    if (movingItemId && gridEl) {
      const cell = getCellFromMouse(e.clientX, e.clientY);
      if (cell) {
        dropTarget = cell;
        if (cell.r !== moveStartCell.r || cell.c !== moveStartCell.c) hasMovedWhileDragging = true;
        render();
      }
    }
  });

  window.addEventListener('mouseup', async () => {
    if (isModalOpen) return;
    if (movingItemId) {
      const it = state.items.find(x => x.id === movingItemId);
      if (it && hasMovedWhileDragging && dropTarget && (dropTarget.r !== moveStartCell.r || dropTarget.c !== moveStartCell.c)) {
        if (!tryMoveItem(it, dropTarget.r, dropTarget.c)) await showAlert('Perhatian', 'Tidak bisa pindah: area tertutup objek lain.');
      } else if (it && !hasMovedWhileDragging) {
        const itemIdToDel = movingItemId;
        const now = Date.now();
        if (pendingClickItemId === itemIdToDel && (now - pendingClickTime) < 500) {
          pendingClickItemId = null;
          if (pendingDeleteTimeout) { clearTimeout(pendingDeleteTimeout); pendingDeleteTimeout = null; }
          movingItemId = null; moveStartCell = null; dropTarget = null;
          const target = state.items.find(x => x.id === itemIdToDel);
          if (target) {
            const newName = await showModal({
              title: 'Ubah Nama Objek',
              desc: `Objek saat ini: \"${target.name}\"`,
              hint: 'Masukkan nama baru.',
              showInput: true,
              placeholder: target.name || '',
              defaultValue: target.name || '',
              okText: 'Simpan',
              okClass: 'bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300',
              validate: (v) => String(v || '').trim().length > 0,
            });
            if (newName) { target.name = newName.trim(); }
          }
          render();
          return;
        }
        pendingClickItemId = itemIdToDel;
        pendingClickTime = now;
        if (pendingDeleteTimeout) clearTimeout(pendingDeleteTimeout);
        pendingDeleteTimeout = setTimeout(async () => {
          pendingDeleteTimeout = null;
          pendingClickItemId = null;
          const target = state.items.find(x => x.id === itemIdToDel);
          if (!target) return;
          const okDel = await showModal({
            title: 'Konfirmasi Hapus Objek',
            desc: `Hapus \"${target.name}\" dari denah?`,
            hint: null,
            showInput: false,
            okText: 'Hapus',
            okClass: 'bg-red-600 hover:bg-red-700 disabled:bg-red-300',
            validate: null,
          });
          if (okDel) {
            state.items = state.items.filter(x => x.id !== itemIdToDel);
          }
          render();
        }, 450);
      }
      movingItemId = null;
      moveStartCell = null;
      dropTarget = null;
      render();
      return;
    }
    if (!isMouseDown || !mode || !dragStart || !dragEnd) { resetTempSelection(); return; }
    const rect = rectNormalize(dragStart, dragEnd);
    let subType = 'rack';
    if (mode === 'add_table_visitor') subType = 'table_visitor';
    if (mode === 'add_table_librarian') subType = 'table_librarian';
    if (mode === 'add_table_guest') subType = 'table_guest';
    if (mode === 'add_door') subType = 'door';
    const ok = await addItem(rect, subType);
    resetTempSelection();
    render();
  });

  await ensureGridSize();
  render();
  requestAnimationFrame(() => render());
  setTimeout(() => render(), 100);
  setTimeout(() => render(), 300);
  setTimeout(() => render(), 600);
  updateModeButtons();

  const formAddRoom = document.getElementById('formAddRoom');
  if (formAddRoom) {
    formAddRoom.addEventListener('submit', async (e) => {
      e.preventDefault();
      const namaRuangan = (document.getElementById('inputNamaRuangan')?.value || '').trim();
      const username = (document.getElementById('inputUsername')?.value || '').trim();
      const password = (document.getElementById('inputPassword')?.value || '').trim();
      if (!namaRuangan) {
        await showAlert('Perhatian', 'Nama ruangan wajib diisi.');
        return;
      }
      if (!username) {
        await showAlert('Perhatian', 'Username admin wajib diisi.');
        return;
      }
      if (!password) {
        await showAlert('Perhatian', 'Password wajib diisi.');
        return;
      }
      if (state.items.length === 0) {
        await showAlert('Perhatian', 'Desain denah ruangan wajib diisi. Tambahkan minimal satu item (rak, meja, atau pintu) ke denah sebelum menyimpan.');
        return;
      }
      formAddRoom.submit();
    });
  }
})();
</script>
